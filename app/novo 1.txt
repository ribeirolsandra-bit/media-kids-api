# -*- coding: utf-8 -*-
import base64
import json
import os
import re  # Indispensable pour re.search
import openai
from pathlib import Path
from typing import List
from fastapi import FastAPI
from fastapi.staticfiles import StaticFiles
from pydantic import BaseModel

# =====================
# CONFIG
# =====================
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
MOCK = os.getenv("MOCK", "false").lower() == "true"

client = openai.OpenAI(api_key=OPENAI_API_KEY)

# Dossier de base pour les médias
MEDIA_ROOT = Path("media")
(MEDIA_ROOT / "images").mkdir(parents=True, exist_ok=True)

FORBIDDEN_TERMS = ["frappe", "agresse", "donne un coup", "viol", "sexe"]

app = FastAPI(title="Kids Asset API")
app.mount("/media", StaticFiles(directory="media"), name="media")

class GenerateRequest(BaseModel):
    prompt: str
    themes_possibles: List[str]

# =====================
# CORE LOGIC
# =====================

def validate_and_generate_metadata(user_prompt: str, themes_possibles: List[str]) -> dict:
    prompt_clean = user_prompt.strip()
    prompt_len = len(prompt_clean) # Correction : définition de la variable
    
    # 1️⃣ FILTRE : Taille (Synchronisé avec ton DTO Java @Size)
    if prompt_len < 3 or prompt_len > 200:
        return {
            "status": "refused",
            "reason": "PROMPT_SIZE_INVALID"
        }

    # 2️⃣ FILTRE : Anti-gibberish
    if not any(v in prompt_clean.lower() for v in "aeiouy") or re.search(r'(.)\1{4,}', prompt_clean):
        return {
            "status": "refused",
            "reason": "PROMPT_GIBBERISH_NOT_ALLOWED"
        }
    
    # Mode MOCK
    if MOCK:
        if "bloque" in prompt_clean.lower():
            return {"status": "refused", "reason": "PROMPT_REFUSED_VIOLENCE"}
        
        return {
            "status": "approved",
            "category": "SAFE_PREVENTION",
            "theme": themes_possibles[0] if themes_possibles else "other",
            "description": {"fr": "situation mock", "en": "mock situation", "pt": "situação mock"},
            "tags": {"fr": ["mock"], "en": ["mock"], "pt": ["mock"]}
        }

    # 3️⃣ FILTRE : Mots interdits locaux
    if any(term in prompt_clean.lower() for term in FORBIDDEN_TERMS):
        return {"status": "refused", "reason": "PROMPT_REFUSED_VIOLENCE"}

    # 4️⃣ APPEL GPT pour validation sémantique et métadonnées
    prompt_gpt = f"""
    Tu es un assistant pour générer des métadonnées pour des illustrations éducatives pour enfants.
    Prompt : "{prompt_clean}"
    Catégories : SAFE_PREVENTION, EMOTION, VIOLENCE, INAPPROPRIE.
    Thèmes possibles : {themes_possibles}
    
    Réponds en JSON strict :
    {{
      "category": "",
      "theme": "",
      "description": {{ "fr": "", "en": "", "pt": "" }},
      "tags": {{ "fr": [], "en": [], "pt": [] }}
    }}
    Si le prompt est incohérent ou sans sens, utilise 'INAPPROPRIE'.
    """

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "user", "content": prompt_gpt}],
        response_format={"type": "json_object"}
    )

    data = json.loads(response.choices[0].message.content)

    if data["category"] in ["VIOLENCE", "INAPPROPRIE"]:
        return {"status": "refused", "reason": "PROMPT_REFUSED_VIOLENCE"}

    data["status"] = "approved"
    return data

def generate_image(user_prompt: str, theme: str) -> str:
    # Slugify le thème pour le nom du dossier
    theme_folder = theme.lower().replace(" ", "_")
    theme_dir = MEDIA_ROOT / "images" / theme_folder
    theme_dir.mkdir(parents=True, exist_ok=True)
    
    if MOCK:
        return f"/media/images/other/mock.png"

    # Ton prompt DALL-E 3
    real_prompt = f"""
Educational children illustration, vector style.

STYLE RULES:
- Cute children illustration
- Thick rounded dark brown outlines
- Constant outline thickness
- Soft flat colors with very light gradients
- No textures
- No shadows
- No realism
- Rounded simple shapes

CHARACTER:
- Big head
- Small body
- Simple face
- Friendly expression

SUBJECT:
{user_prompt}

OUTPUT:
- Full body
- Centered
- Transparent background
"""
   response = client.images.generate(
        model="gpt-image-1",
        prompt=real_prompt,
        size="auto",
        background="transparent"
    )

    image_b64 = response.data[0].b64_json
    filename = f"asset_{os.urandom(3).hex()}.png"
    filepath = THEME_DIR / filename

    with open(filepath, "wb") as f:
        f.write(base64.b64decode(image_b64))

    return f"/media/images/{theme}/{filename}"

@app.post("/generate")
def generate_asset(payload: GenerateRequest):
    metadata = validate_and_generate_metadata(payload.prompt, payload.themes_possibles)
    if metadata["status"] != "approved":
        return metadata

    url_media = generate_image(payload.prompt, metadata["theme"])
    metadata["url_media"] = url_media
    return metadata